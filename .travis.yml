language: python
sudo: false
cache:
  directories:
  - eggs
  - ".npm"
addons:
  apt:
    sources:
    - elasticsearch-1.7
    packages:
    - bsdtar
    - elasticsearch
    - graphviz
  sauce_connect: true
env:
  global:
  - PATH="/usr/share/elasticsearch/bin:/usr/lib/postgresql/9.3/bin:$PATH"
  - ELASTIC_BEANSTALK_LABEL=$TRAVIS_COMMIT
  - secure: vovAkyWqRwZdzZYc061JuENHIPxnjek1t7TWnzeo8AwQdFQwhbt76z0XV9g5DvjYclUWdYxfOb7fiUyxc8M0M2wPfwU05uStewWTuBKILobaNqMdsWaxRQ9OSJ3NxqTLabnmIsAuCQPwHFqM6etyHXiMaAgK8EU+r23CRzklMY77vQMN/2Bs+3Y1ngZ17OVvdbmAwzlUS0uE7+P9X2YXz6QVeTvyPWnBr5SMZ/gyA1/LU+44svKLC85BLtG+2YWHwEOPl0+Jt8diOP+UMBVI0GkCl2cN0dLQhVP26Jcp479BpnPVMOsRqH+Ve9qxpfY6aesTjAVc3D7AJcKzlOnA9o7GTaVGj0pWV+eCv9n3pFacIJkTF1/JNI3lmqKlWyeRd1qMCgCi94mNXEKEgXfxVBSczALhZcxHWTMYo1jE1aDAaAj09yukMJ9UEIBVSQsAGywihlFvTtUTwZDpd0cSfl2RYx6z845HU5EX9oNASEYcbC237I83bObu232ljRokBixA5fo4y+TLNLwK97DsFNGocIXsPBKVBq8uCClD3S8kG9sB88vjM9bFnkenw7GfZLjJFChzd4Hw+x4xJQH0L99MbWeMYAl9R/ojqk3tVrpGEpXwmf/MOgTmVGPUEExgeRTSWUn95YrpenOx7FsJJQ4ZpD1rnVRev2X0A21l0H0=
  - secure: VaAvhzAtXo69D1TthYVabBSu/ESHj+/Wura9+XuFA6aG27tWQSZJ1FWPBN0nax2/vs4MkZfW19qbXgxFZBE671eYiu53iXvi4JbJRJU6efG08gQH4wpsOhxg0WF4+uWIpbIok5dCUPVLh0nTkHBpFAlcgTn6O/ST7hYFliEUxwcRATBe6fslJcLpR6fmsnNVs6kwkv1MvkMikje3fCbfj+V8/dHqQRobwCbMlgJMuxV+MWx4RUfKimQ/oUGCef6YCzcilTEgW4fAdPLsxqZiGn8wihC3lpjNYyGOfX/NCzPo8iVtX49X+Dp+sePRxKgWvovwLQDCWkomMBpxtdea/bkkPg7v92G0ivCcYX8hs14WCWjkqScCk6B0XACyMmE7dCE2Xte86sarxGbsp5lp39OvQxAbFbK+QBEKfPOdoxkcM3rrhf+kAnq+PsH1HrzzGe1F3L0BTpeS9F8w26skgrXmR/6X78mMzLk2TtHmXf3qPpPcFEP+fEOfiZyJSLEvfti9fVjZWSkCDUDEuvgF5haYpKy+cgzMHyHIgJZxfokyRvY7mEWwDZzqnSGvvVx/km0LjkQUY0RCvoT5xAtFSC2AguTfJ1C1RlZvuuYxBHa3a7tFn+ahPfRtdtFpcEGjwKBDRTNY5xzKrzozXLVQHpPVYhFQndPSF2n3+0JwE6M=
  - secure: Zi1Fg04BvfjBi54dvSs5vA82habY/SHakKnXd0Ogd3IMSzzNI5OWYAerNKhbz2iHqHx2Uy5Qz8JplICVw9Tbm2ENXma8xZfTONr264q9S6P4Pzc/xmoRXPXX7J4sqgzqDu7KoJJvan1jfdZVczQq1TIYrH/XxPz3gkEYlt4Jym3mvngb2t+Hd7I+6hwB/Wm/BO391R6CH7tc1KoKS05IylQCfjpdvbRMNFkAmZu59KJR5iSVbvHpzr2BePgGcvl+A9Hq6A6P886Wl/UuNfdROX3PT22PLy8Wl/6jRfGGyfU9gWT9IqT9glBNDQjb7fqk71Jy+DK3HWL56nRfAlXOShtA8Qev/zTgBJreMUtvcyNpW98PphAyQLE7AvbfqJ9/x5dOTTT7alNh2RTTxlzcnvEHRPwSmPqVibfKjqUQUhIa2iQ4qhfzBp6IjaeeEZY6VMplwm6qwr6Rp0J6FhZhZyzeLwulzOnBtaa/5paI54s+z6pYSib9PvKe3uRgNKwxR7o/Thqd1WtFH80o3gWaF+REeXwzpM9MODszaipvtiLci9br2BbNNcdFQREtCuf9X2RxG3nW9Jh2W/Wrvbo/39wbMaxVmmtRahFtq+MjhfZzN+ThCgRXk0JG/EjdOxaNjta5iZU962gUj3wr9yZNWVSUGrFMGkyIa6BRA3OZZ/M=
  - secure: JXMLW6AmtlTVERT1e3XWaa6c2CrNKwlfEmcBBlMc11am2yeSp9yMEMd3ZnOI2CozeoHezBzdmTSqxm1uTuZT6U3lPrevU16ir/kdxzHa/K2NANAxQPPkhaSO0BjYEU03rAHm4n5HvutwRCNOuJFbE3XtPizSc6FQ3XOI9zq1RQQp2Dn5xXKbVBWEhzL+fHLx2AWfomprUU8O0a5TYY5xjaPYN9EBBieFhm5sI2N5/Sv95MSVbzfMa5VSNzHqwHeaZ8tt5L7Rv2otLLxUJblxRSiYkVyD1OZVU3YlrJGb+FkCFC8YDgz1RZ4mistCJtBG9/tRKztPBP93B/tb5g0wO2kZ6Mv71NHPXigWrXesBmu430GMvCnCYZgXVS4nT0cQHt7UyG0RU2LYwLzYr8Sn7StlEr5RL+TzDW28lHY4LK4+z+Gbk+ApxBinPZfpZCqvPYqvUiFBj0HOKxn6IC8ELZ3QHZd1XwkiPRTntfQ+lElg9M+aEvAKcN2FEE3o9RG6PG57xH7wIeQkeNMLSkLbREL3xXl3hWbgY7DOj7CyiokKyCAgM+1fpquIE7GKZdTBiAWl7z7y9iNYO9tDyLA08Cbp9nIU6llGFkEZ+QZWn5hkjYch36imEl7SBWYTANGsdNc1SNocWKK4pUhOycOokOS2fI7l5W/eBHTG/vlqUOw=
  - secure: PotXkx2ykgYzVce32FZKUxkXazfiCZ0yqWLhosci27YnwOlCimH+XL97eM5enQFiU/YYI/ETYkhesuNuobTxFpXo383xIgt35rfD60Tp+sSmZTXOdveC2fnhqvm55/jysoMFN1nBMe/0VSOAFnMAzSX6qYvlsc9yC4LSTHiRyo7aev2iVKW5As1wmE9Cs+O0ee7azanckLXGPibIpijSf8D0IPu1w5CUR3/UBkL6rMQ3Ir8R8sAJpOtzW3O5Rx2F97swShhWa/gmk6zYu4RS+Q1Lr2MbVdlrrOgT/czkxsPIqIWmRP4L5nLS2L/wYtCiCatwUZm5LVP9bA6+vWbPagTOHm+2/VYqTn4QMiAbpRHZjLIQxQd067XOE/JsYrLUrCWquqEZ1XmT04gSI+rgvf0+oU0Wno19lgN0BArNOHG8GEPSugciB/I/tY6aV1jXiam5uRJc/tBgaQaRWiGRXKdFdB0BDbyKlcxxXq+1Fc6b//7qbeaioREj72z1aN37AKVfe+F+cx7gMX85OuFhyyX5ZV7S2i4fyrH4krlHTLWywdPVAMuggV0lITvSflhj8AE2U6A8yedAdt8I1UZDOkkns4HlCl8I7EXqCjGcLs2uYdiSTh1yzkKCYKSXpWH0nEUqr3j1cpghUJ3cjg1licQH2GzIIqlp7u/XTfody80=
matrix:
  include:
  - python: '3.4'
    env: BROWSER=Chrome
  - python: '3.4'
    env: BROWSER=
before_install:
- postgres --version
- initdb --version
- elasticsearch -v
- nvm install 4
- node --version
- npm config set python /usr/bin/python2.7
install:
- python bootstrap.py --buildout-version 2.4.1 --setuptools-version 18.1
- bin/buildout -c buildout-travis.cfg || (echo "Retrying buildout" && bin/buildout
  -c buildout-travis.cfg)
before_script:
- |
  if test -n "$BROWSER"; then
    CONNECT_URL=https://saucelabs.com/downloads/sc-4.3.8-linux.tar.gz
    CONNECT_DOWNLOAD=sc.tar.gz
    SC_READYFILE=sauce-connect-ready-$RANDOM
    SC_LOGFILE=$HOME/sauce-connect.log
    SC_PIDFILE=$HOME/sauce-connect.pid
    curl $CONNECT_URL > $CONNECT_DOWNLOAD
    mkdir sc
    tar -zxf $CONNECT_DOWNLOAD --strip 1 --directory sc
    sc/bin/sc --readyfile $SC_READYFILE \
      --logfile $SC_LOGFILE \
      --pidfile $SC_PIDFILE \
      --tunnel-identifier $TRAVIS_JOB_NUMBER \
      --user $SAUCE_USERNAME --api-key $SAUCE_ACCESS_KEY > /dev/null &
    while test -f "$SC_PIDFILE" && test ! -f "$SC_READYFILE"; do sleep .5; done
  fi
script:
        - if test -z "$BROWSER"; then npm test; fi
        #- if test -z "$BROWSER"; then bin/test -v -v --timeout=200 -m "not bdd"; fi
        #- |
  #if test -n "$BROWSER"; then
  #test -f "$SC_PIDFILE" && bin/test -v -v --timeout=200 -m "bdd" --tb=short \
  #    --splinter-implicit-wait 10 \
  #    --splinter-webdriver remote \
  #    --splinter-remote-url "http://$SAUCE_USERNAME:$SAUCE_ACCESS_KEY@localhost:4445/wd/hub" \
  #    --splinter-socket-timeout 300 \
  #    --browser-arg tunnel-identifier "$TRAVIS_JOB_NUMBER" \
  #    --browser-arg-int build  "$TRAVIS_BUILD_NUMBER" \
  #    --browser-arg-int idleTimeout 300 \
  #    --browser-arg name "$TRAVIS_REPO_SLUG $TRAVIS_BRANCH $TRAVIS_COMMIT" \
  #    --browser-arg browser "$BROWSER"
  #fi
after_script:
- |
  if test -f "$SC_PIDFILE"; then
    SAUCE_JOB_ID=`grep -m 1 /session/ "$HOME/sauce-connect.log" | cut -d / -f 7`
    SAUCE_PASSED=`((TRAVIS_TEST_RESULT == 0)) && echo true || echo false`
    curl -H "Content-Type:text/json" -s -X PUT -d "{\"passed\": $SAUCE_PASSED}" \
      "http://$SAUCE_USERNAME:$SAUCE_ACCESS_KEY@saucelabs.com/rest/v1/$SAUCE_USERNAME/jobs/$SAUCE_JOB_ID" > /dev/null
    echo "Sauce test page https://saucelabs.com/tests/$SAUCE_JOB_ID"
    kill $(cat "$SC_PIDFILE")
    wait $(cat "$SC_PIDFILE")
  fi
deploy:
    provider: elasticbeanstalk
    region: us-east-1
    app: 4dn-web
    env: 4dn-web-dev
    bucket-name: $ELASTIC_BEANSTALK_BUCKET
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_ACCESS_KEY
    on:
        repo: hms-dbmi/encode  
        branch: master
