[buildout]
extensions =
    mr.developer
extends = versions.cfg
# XXX https://bitbucket.org/pypa/setuptools/issue/133/find-links-should-override-allow-hosts
allow-hosts =
    *.python.org
    github.com
find-links =
    https://github.com/lrowe/venusian/tarball/1.0.1.dev40#egg=venusian-1.0.1.dev40
    https://github.com/lrowe/splinter/tarball/0.7.3.dev20150610#egg=splinter-0.7.3.dev20150610
    https://github.com/RDFLib/rdflib/tarball/f2bef7a#egg=rdflib-4.2.2.dev0
show-picked-versions = true
update-versions-file = versions.cfg
parts =
    encoded
    production-ini
    production
    production-indexer
    production-fileindexer
    rubygems
    compile-css
    ckeditor
    npm-install
    npm-update
    compile-js
    test
    aws
    generate-ontology
    aws-ip-ranges
develop = .
sources-dir = develop
auto-checkout = snovault
		Submit4DN

[sources]
snovault = git https://github.com/4dn-dcic/snovault.git branch=master
Submit4DN = git https://github.com/4dn-dcic/Submit4DN rev=0.9.7
behave = git https://github.com/behave/behave.git
behaving = git https://github.com/ggozad/behaving.git
jsonschema = git https://github.com/lrowe/jsonschema_serialize_fork.git
rubygemsrecipe = hg https://bitbucket.org/lrowe/rubygemsrecipe
subprocess_middleware = git https://github.com/lrowe/subprocess_middleware.git
subprocess-middleware-node = git https://github.com/lrowe/subprocess-middleware-node.git egg=false
pyramid = git https://github.com/Pylons/pyramid.git
pyramid_multiauth = git https://github.com/mozilla-services/pyramid_multiauth.git
pytest = hg https://bitbucket.org/hpk42/pytest
rdflib = git https://github.com/lrowe/rdflib.git branch=patch-1
rdflib-jsonld = git https://github.com/lrowe/rdflib-jsonld.git branch=patch-1
jsonform = git https://github.com/lrowe/jsonform.git egg=false
webtest = git https://github.com/Pylons/webtest.git
WSGIProxy2 = git https://github.com/lrowe/WSGIProxy2.git
zope.sqlalchemy = git https://github.com/zopefoundation/zope.sqlalchemy.git
pytest-bdd = git https://github.com/lrowe/pytest-bdd.git branch=allow-any-step-order

[versions]
# Hand set versions
pyramid = 1.6a2
# Update .travis.yml and cloud-config.yml when updating buildout
zc.buildout = 2.4.1
setuptools = 18.1
# https://github.com/Pylons/venusuian/issues/40
venusian = 1.0.1.dev40
# https://github.com/RDFLib/rdflib/issues/492
rdflib = 4.2.2.dev0

[encoded]
recipe = zc.recipe.egg
eggs =
    SPARQLWrapper
    encoded
    pyramid
    waitress
    psycopg2
    repoze.debug
    rutter
    pyramid_translogger

interpreter = py

[aws]
recipe = zc.recipe.egg
eggs =
    awscli

[production-ini]
recipe = collective.recipe.template
input = ${buildout:directory}/production.ini.in
output = ${buildout:directory}/production.ini
accession_factory = encoded.server_defaults.enc_accession
file_upload_bucket = elasticbeanstalk-encoded-4dn-files
file_wfout_bucket = elasticbeanstalk-encoded-4dn-wfout
blob_bucket = elasticbeanstalk-encoded-4dn-blobs
system_bucket = elasticbeanstalk-encoded-4dn-system
#region_search_instance = region-search-test.instance.encodedcc.org:9200
#region_search_instance = ec2-52-23-165-123.compute-1.amazonaws.com:9200
#elasticsearch_instance = ec2-52-23-165-123.compute-1.amazonaws.com:9200
region_search_instance = 172.31.49.128:9872
# TODO set elastic search server from bootstrap
elasticsearch_instance = 172.31.49.128:9872
elasticsearch_index = snovault
load_test_data = encoded.loadxl:load_test_data
indexer_processes =
encoded_version = v-c970d5b5d7b9852adcdbcbe077f4e6958f584564
sqlalchemy_url =
env_name = local
create_tables = true


[production]
recipe = collective.recipe.modwsgi
eggs =
    encoded
    psycopg2
config-file = ${buildout:directory}/production.ini

[production-indexer]
<= production
app_name = indexer

[production-fileindexer]
<= production
app_name = fileindexer

[rubygems]
recipe = rubygemsrecipe
version = 2.6.7
# Put dependencies first for pinning to work
gems =
    sass==3.4.22
    chunky_png==1.3.7
    fssm==0.2.10
    multi_json==1.12.1
    compass-core==1.0.3
    compass-import-once==1.0.5
    rb-fsevent==0.9.8
    ffi==1.9.14
    rb-inotify==0.9.7
    compass==1.0.3

[compile-css]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
    ${buildout:directory}/bin/compass compile

[ckeditor]
recipe = collective.recipe.cmd
on_install = true
on_update = true
# See http://stackoverflow.com/a/23108309/199100
cmds =
    curl https://s3-us-west-1.amazonaws.com/encoded-build/ckeditor/ckeditor_4.5.5_standard.zip | bsdtar -xf- -C src/encoded/static/build/

[generate-ontology]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
    curl -o ontology.json https://s3.amazonaws.com/elasticbeanstalk-encoded-4dn-system/ontology-2017-03-23.json

[aws-ip-ranges]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
    curl -o aws-ip-ranges.json https://ip-ranges.amazonaws.com/ip-ranges.json

[npm-install]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds = NODE_PATH="" npm_config_cache="" npm install

[npm-update]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds = NODE_PATH="" npm_config_cache="" npm update --dependencies

[compile-js]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds = NODE_PATH="" npm run build | grep -v "node_modules\|\[built\]"


[test]
recipe = zc.recipe.egg
eggs =
    coverage
    encoded[test]
    psycopg2
    pytest
    pytest-timeout
    pytest-instafail
    pytest-cov
    pytest-bdd
scripts =
    coverage
    py.test=test
    pytest-bdd

# Avoid ``Unix-domain socket path "..." is too long (maximum 103 bytes)``
initialization = import tempfile; tempfile.tempdir = '/tmp'
