packages:
  yum:
    git: []
    postgresql93-devel: []
    libffi-devel: []
    libjpeg-turbo-devel: []
    libtiff: []
    ruby-devel: []
    bsdtar: []
    graphviz: []
    mod24_ssl: []

container_commands:
  01_nodejs_install:
    command: curl --silent --location https://rpm.nodesource.com/setup_7.x | sudo bash - && yum install nodejs -y && node --version
  02_setup_apache:
    command: cp .ebextensions/encoded-apache.conf /etc/httpd/conf.d/encoded-apache.conf
  03_bootstrap:
    command: "source /opt/python/run/venv/bin/activate && python bootstrap.py --buildout-version 2.4.1 --setuptools-version 18.1 > /var/log/deploy.log"
  04_buildout:
    test: '[[ "$ENV_NAME" != "PROD" ]]'
    command: "source /opt/python/run/venv/bin/activate && bin/buildout  >> /var/log/deploy.log"
  045_buildout:
    test: '[[ "$ENV_NAME" = "PROD" ]]'
    command: "source /opt/python/run/venv/bin/activate && bin/buildout -c production.cfg  >> /var/log/deploy.log"
  05_secret_key:
    command: cat /dev/urandom | head -c 256 | base64 > session-secret.b64
  06_jerry_rig_pyramid_config:
    command: "source /opt/python/run/venv/bin/activate && python deploy/set_beanstalk_config.py >> /var/log/deploy.log"
  07_elastic_search_mapping:
    command: "bin/create-mapping production.ini --app-name app  >> /var/log/deploy.log"
    leader_only: true
  08_elastic_search_index:
    command: "bin/index-annotations production.ini --check-first --app-name app  >> /var/log/deploy.log" 
    leader_only: true
  09_load_dummy_data:
    command: "bin/load-data production.ini --app-name app  >> /var/log/deploy.log"
    leader_only: true
  10_setup_wsgi_home:
    command: "mkdir -p /home/wsgi && chown wsgi:wsgi /home/wsgi" 
option_settings:
  "aws:elasticbeanstalk:application:environment":
     "LC_ALL" : "en_US.UTF-8"
     "LANG" : "en_US.UTF-8"
  "aws:elasticbeanstalk:container:python:staticfiles":
    "/static/": "src/encoded/static/"
  "aws:elasticbeanstalk:container:python":
    WSGIPath: parts/production/wsgi
