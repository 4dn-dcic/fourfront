(function(){"use strict",window.BrowserID=window.BrowserID||{};var a=window.BrowserID,b={KEY_LENGTH:128,PASSWORD_MIN_LENGTH:8,PASSWORD_MAX_LENGTH:80,URL_MAX_LENGTH:2083,PATH_MAX_LENGTH:2048};for(var c in b)a[c]=b[c]})();var Channel=function(){function e(a){return Array.isArray?Array.isArray(a):a.constructor.toString().indexOf("Array")!=-1}function d(a,c,d){var e=b[c][d];for(var f=0;f<e.length;f++)e[f].win===a&&e.splice(f,1);b[c][d].length===0&&delete b[c][d]}function c(a,c,d,e){function f(b){for(var c=0;c<b.length;c++)if(b[c].win===a)return!0;return!1}var g=!1;if(c==="*")for(var h in b){if(!b.hasOwnProperty(h))continue;if(h==="*")continue;if(typeof b[h][d]=="object"){g=f(b[h][d]);if(g)break}}else b["*"]&&b["*"][d]&&(g=f(b["*"][d])),!g&&b[c]&&b[c][d]&&(g=f(b[c][d]));if(g)throw"A channel is already bound to the same window which overlaps with origin '"+c+"' and has scope '"+d+"'";typeof b[c]!="object"&&(b[c]={}),typeof b[c][d]!="object"&&(b[c][d]=[]),b[c][d].push({win:a,handler:e})}"use strict";var a=Math.floor(Math.random()*1000001),b={},f={},g=function(a){try{var c=JSON.parse(a.data);if(typeof c!="object"||c===null)throw"malformed"}catch(a){return}var d=a.source,e=a.origin,g,h,i;if(typeof c.method=="string"){var j=c.method.split("::");j.length==2?(g=j[0],i=j[1]):i=c.method}typeof c.id!="undefined"&&(h=c.id);if(typeof i=="string"){var k=!1;if(b[e]&&b[e][g])for(var l=0;l<b[e][g].length;l++)if(b[e][g][l].win===d){b[e][g][l].handler(e,i,c),k=!0;break}if(!k&&b["*"]&&b["*"][g])for(var l=0;l<b["*"][g].length;l++)if(b["*"][g][l].win===d){b["*"][g][l].handler(e,i,c);break}}else typeof h!="undefined"&&f[h]&&f[h](e,i,c)};window.addEventListener?window.addEventListener("message",g,!1):window.attachEvent&&window.attachEvent("onmessage",g);return{build:function(b){var g=function(a){if(b.debugOutput&&window.console&&window.console.log){try{typeof a!="string"&&(a=JSON.stringify(a))}catch(c){}console.log("["+j+"] "+a)}};if(!window.postMessage)throw"jschannel cannot run this browser, no postMessage";if(!window.JSON||!window.JSON.stringify||!window.JSON.parse)throw"jschannel cannot run this browser, no JSON parsing/serialization";if(typeof b!="object")throw"Channel build invoked without a proper object argument";if(!b.window||!b.window.postMessage)throw"Channel.build() called without a valid window argument";if(window===b.window)throw"target window is same as present window -- not allowed";var h=!1;if(typeof b.origin=="string"){var i;b.origin==="*"?h=!0:null!==(i=b.origin.match(/^https?:\/\/(?:[-a-zA-Z0-9_\.])+(?::\d+)?/))&&(b.origin=i[0].toLowerCase(),h=!0)}if(!h)throw"Channel.build() called with an invalid origin";if(typeof b.scope!="undefined"){if(typeof b.scope!="string")throw"scope, when specified, must be a string";if(b.scope.split("::").length>1)throw"scope may not contain double colons: '::'"}var j=function(){var a="",b="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";for(var c=0;c<5;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a}(),k={},l={},m={},n=!1,o=[],p=function(a,b,c){var d=!1,e=!1;return{origin:b,invoke:function(b,d){if(!m[a])throw"attempting to invoke a callback of a nonexistent transaction: "+a;var e=!1;for(var f=0;f<c.length;f++)if(b===c[f]){e=!0;break}if(!e)throw"request supports no such callback '"+b+"'";t({id:a,callback:b,params:d})},error:function(b,c){e=!0;if(!m[a])throw"error called for nonexistent message: "+a;delete m[a],t({id:a,error:b,message:c})},complete:function(b){e=!0;if(!m[a])throw"complete called for nonexistent message: "+a;delete m[a],t({id:a,result:b})},delayReturn:function(a){typeof a=="boolean"&&(d=a===!0);return d},completed:function(){return e}}},q=function(a,b,c){return window.setTimeout(function(){if(l[a]){var d="timeout ("+b+"ms) exceeded on method '"+c+"'";(1,l[a].error)("timeout_error",d),delete l[a],delete f[a]}},b)},r=function(a,c,d){if(typeof b.gotMessageObserver=="function")try{b.gotMessageObserver(a,d)}catch(h){g("gotMessageObserver() raised an exception: "+h.toString())}if(d.id&&c){if(k[c]){var i=p(d.id,a,d.callbacks?d.callbacks:[]);m[d.id]={};try{if(d.callbacks&&e(d.callbacks)&&d.callbacks.length>0)for(var j=0;j<d.callbacks.length;j++){var n=d.callbacks[j],o=d.params,q=n.split("/");for(var r=0;r<q.length-1;r++){var s=q[r];typeof o[s]!="object"&&(o[s]={}),o=o[s]}o[q[q.length-1]]=function(){var a=n;return function(b){return i.invoke(a,b)}}()}var t=k[c](i,d.params);!i.delayReturn()&&!i.completed()&&i.complete(t)}catch(h){var u="runtime_error",v=null;typeof h=="string"?v=h:typeof h=="object"&&(h&&e(h)&&h.length==2?(u=h[0],v=h[1]):typeof h.error=="string"&&(u=h.error,h.message?typeof h.message=="string"?v=h.message:h=h.message:v=""));if(v===null)try{v=JSON.stringify(h),typeof v=="undefined"&&(v=h.toString())}catch(w){v=h.toString()}i.error(u,v)}}}else d.id&&d.callback?!l[d.id]||!l[d.id].callbacks||!l[d.id].callbacks[d.callback]?g("ignoring invalid callback, id:"+d.id+" ("+d.callback+")"):l[d.id].callbacks[d.callback](d.params):d.id?l[d.id]?(d.error?(1,l[d.id].error)(d.error,d.message):d.result!==undefined?(1,l[d.id].success)(d.result):(1,l[d.id].success)(),delete l[d.id],delete f[d.id]):g("ignoring invalid response: "+d.id):c&&k[c]&&k[c]({origin:a},d.params)};c(b.window,b.origin,typeof b.scope=="string"?b.scope:"",r);var s=function(a){typeof b.scope=="string"&&b.scope.length&&(a=[b.scope,a].join("::"));return a},t=function(a,c){if(!a)throw"postMessage called with null message";var d=n?"post  ":"queue ";g(d+" message: "+JSON.stringify(a));if(!c&&!n)o.push(a);else{if(typeof b.postMessageObserver=="function")try{b.postMessageObserver(b.origin,a)}catch(e){g("postMessageObserver() raised an exception: "+e.toString())}b.window.postMessage(JSON.stringify(a),b.origin)}},u=function(a,c){g("ready msg received");if(n)throw"received ready message while in ready state.  help!";c==="ping"?j+="-R":j+="-L",v.unbind("__ready"),n=!0,g("ready msg accepted."),c==="ping"&&v.notify({method:"__ready",params:"pong"});while(o.length)t(o.pop());typeof b.onReady=="function"&&b.onReady(v)},v={unbind:function(a){if(k[a]){if(delete k[a])return!0;throw"can't delete method: "+a}return!1},bind:function(a,b){if(!a||typeof a!="string")throw"'method' argument to bind must be string";if(!b||typeof b!="function")throw"callback missing from bind params";if(k[a])throw"method '"+a+"' is already bound!";k[a]=b;return this},call:function(b){if(!b)throw"missing arguments to call function";if(!b.method||typeof b.method!="string")throw"'method' argument to call must be string";if(!b.success||typeof b.success!="function")throw"'success' callback missing from call";var c={},d=[],e=function(a,b){if(typeof b=="object")for(var f in b){if(!b.hasOwnProperty(f))continue;var g=a+(a.length?"/":"")+f;typeof b[f]=="function"?(c[g]=b[f],d.push(g),delete b[f]):typeof b[f]=="object"&&e(g,b[f])}};e("",b.params);var g={id:a,method:s(b.method),params:b.params};d.length&&(g.callbacks=d),b.timeout&&q(a,b.timeout,s(b.method)),l[a]={callbacks:c,error:b.error,success:b.success},f[a]=r,a++,t(g)},notify:function(a){if(!a)throw"missing arguments to notify function";if(!a.method||typeof a.method!="string")throw"'method' argument to notify must be string";t({method:s(a.method),params:a.params})},destroy:function(){d(b.window,b.origin,typeof b.scope=="string"?b.scope:""),window.removeEventListener?window.removeEventListener("message",r,!1):window.detachEvent&&window.detachEvent("onmessage",r),n=!1,k={},m={},l={},b.origin=null,o=[],g("channel destroyed"),j=""}};v.bind("__ready",u),setTimeout(function(){t({method:s("__ready"),params:"ping"},!0)},0);return v}}}();(function(){"use strict",window._={extend:function(a){var b=[].slice.call(arguments,1);_.each(b,function(b){_.each(b,function(b,c){a[c]=b})});return a},each:function(a,b,c){if(_.isArray(a)){var d=a.length;for(var e=0;e<d;++e)b.call(c,a[e],e,a)}else for(var f in a)b.call(c,a[f],f,a)},isArray:function(a){return Object.prototype.toString.call(a)==="[object Array]"},isObject:function(a){return a===Object(a)},keys:function(a){var b=[];for(var c in a)b.push(c);return b},indexOf:function(a,b){var c=a.length;for(var d=0;d<c;++d)if(a[d]===b)return d;return-1},keyOf:function(a,b){for(var c in a)if(a[c]===b)return c},size:function(a){return _.isArray(a)?a.length:_.keys(a).length},defer:function(a){var b=[].slice.call(arguments,0);b.splice(1,0,0),_.delay.apply(null,b)},delay:function(a,b){var c=[].slice.call(arguments,2);setTimeout(function(){a.apply(null,c)},b)},isEmpty:function(a){if(a===null)return!0;if("length"in a)return a.length===0;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},difference:function(a){var b=[].slice.call(arguments,1),c=[];_.each(a,function(a){var d=!1;_.each(b,function(b){_.indexOf(b,a)!==-1&&(d=!0)}),d||c.push(a)});return c},intersection:function(a){var b=[].slice.call(arguments,1),c=[];_.each(a,function(a){var d=!0;_.each(b,function(b){_.indexOf(b,a)===-1&&(d=!1)}),d&&c.push(a)});return c},escape:function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")}}})(),BrowserID.CODE_VERSION="b419bd2",Hub=function(){function h(){b={},a=[],c=0}function g(c){for(var d in b){var e=b[d];for(var f=0,g;g=e[f];++f)if(g.id===c){e.splice(f,1);break}}for(var h=0,i;i=a[h];++h)if(i.id===c){a.splice(h,1);break}}function f(c){for(var d=0,e;e=a[d];++d)e.callback.apply(null,arguments);var f=b[c];if(f)for(var g=0,h;h=f[g];++g)h.callback.apply(null,arguments)}function e(b,d){a.push({id:c,callback:d?b.bind(d):b});return c++}function d(a,d,e){var f=b[a]=b[a]||[],g=c;f.push({id:c,callback:e?d.bind(e):d}),c++;return g}"use strict";var a=[],b={},c=0;return{all:e,on:d,fire:f,reset:h,off:g}}(),window.Micrajax=function(){function i(c,e,i){var j=b();if(!j)throw"could not get XHR object";j.onreadystatechange=a(d,j,e);var k=(c.type||"GET").toUpperCase(),l=c.contentType||"application/x-www-form-urlencoded",m=g(c.url,k,c.data),i=h(l,k,c.data);j.open(k,m,!0);var n={"Content-type":l};for(var o in c.headers)n[o]=c.headers[o];f(n,j),j.send(i)}function h(a,b,c){var d;if(b!=="GET"&&c)switch(a){case"application/json":typeof c=="string"?d=c:d=JSON.stringify(c);break;case"application/x-www-form-urlencoded":d=e(c);break;default:}return d||null}function g(a,b,c){var d=e(c);b==="GET"&&d&&(a+="?"+d);return a}function f(a,b){var c={"X-Requested-With":"XMLHttpRequest",Accept:"application/json;text/plain"};for(var d in a)c[d]=a[d];for(var d in c)b.setRequestHeader(d,c[d])}function e(a){var b=[],c="";for(var d in a)typeof a[d]!="undefined"&&b.push(encodeURIComponent(d)+"="+encodeURIComponent(a[d]));b&&b.length&&(c=b.join("&"));return c}function d(a,b){try{a.readyState==4&&(a.onreadystatechange=c,b&&b(a.responseText,a.status))}catch(d){}}function c(){}function b(){var a;window.XMLHttpRequest?a=new XMLHttpRequest:window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP"));return a}function a(a){var b=[].slice.call(arguments,1),c=function(){return a.apply(null,b.concat([].slice.call(arguments)))};return c}"use strict";var j={ajax:function(a){var b=a.error,c=a.success,d={readyState:0};i(a,function(a,e){d.status=e,d.responseText=a,d.readyState=4;if(e>=200&&e<300||e===304){var f=a;try{var f=JSON.parse(a)}catch(g){}c&&c(f,a,d)}else b&&b(d,e,a)});return d}};return j}(),function(){"use strict",Function.prototype.bind||(Function.prototype.bind=function(a){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be fBound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d?this:a||window,b.concat(Array.prototype.slice.call(arguments)))};d.prototype=this.prototype,e.prototype=new d;return e}),Function.prototype.curry||(Function.prototype.curry=function(){var a=this,b=Array.prototype.slice.call(arguments);return function(){return a.apply(this,b.concat(Array.prototype.slice.call(arguments)))}}),window.console||(window.console={}),window.console.log||(window.console.log=function(){}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")})}(),BrowserID.Mediator=function(){var a=Hub;return{subscribeAll:a.all.bind(a),subscribe:a.on.bind(a),unsubscribe:a.off.bind(a),publish:a.fire.bind(a),reset:a.reset.bind(a)}}(),function(){function m(a){return String(a).replace(l,"")}function k(){try{var a="",b=[].slice.call(arguments,0);_.each(b,function(b,c){c>0&&(a+=", ");var d=Object.prototype.toString.apply(b);if(d==="[object String]")a+=b;else if(d==="[object Object]")try{a+=JSON.stringify(b,null,2)}catch(e){a+="<<object>>"}else d==="[object Function]"?a+="<<function>>":a+=String(b)}),window.console.log(a)}catch(c){}}function j(a){if(a){var b=[].slice.call(arguments,1);a.apply(null,b)}}function i(a){return function(b){b&&b.preventDefault(),a.call(this)}}function h(a,b){var c={};_.each(_.keys(a),function(d){_.indexOf(b,d)!==-1&&(c[d]=a[d])});return c}function g(a,b){var c=a,d=[];for(var e in b)d.push(e+"="+encodeURIComponent(b[e]));d.length&&(c+="?"+d.join("&"));return c}function f(a){var d=b.getInner(a)||"";return c.password(d)?d:null}function e(a){var d=(b.getInner(a)||"").trim();return c.email(d)?d:null}"use strict";var a=BrowserID,b=a.DOM,c=a.Validation,d=a.Helpers=a.Helpers||{},l=/.*@/;_.extend(d,{getAndValidateEmail:e,getAndValidatePassword:f,toURL:g,whitelistFilter:h,cancelEvent:i,complete:j,log:k,getDomainFromEmail:m})}(),BrowserID.getStorage=function(){var a;try{a=localStorage}catch(b){a={removeItem:function(a){this[a]=null,delete this[a]}}}return a},BrowserID.Storage=function(){function P(){var a=M();if(a){var d="idpVerification"+a;c.removeItem(d)}for(var e=0;e<localStorage.length;++e){var f=localStorage.key(e);if(/^idpVerification/.test(f)){var g;try{g=JSON.parse(c.getItem(f))}catch(h){c.removeItem(f);continue}if(!g||!g.created){c.removeItem(f);continue}var i=(new Date(g.created)).getTime(),j=(new Date).getTime()-b;i<j&&c.removeItem(f)}}}function O(a,b){b||(b=a,a=String(Math.random())),d.name=d.sessionStorage.idpNonce=a,b.created||(b.created=(new Date).toString()),c["idpVerification"+a]=JSON.stringify(b)}function N(a){a=a||M();if(!!a){var b="idpVerification"+a,d=c[b],e;if(d)try{e=JSON.parse(d)}catch(f){c.removeItem(b);throw f}return e}}function M(){var a=sessionStorage.idpNonce||d.name,b;a==="__persona_dialog"&&(a=b);return a}function L(a,b){var d;try{d=JSON.parse(c.emailToUserID);if(typeof d!="object"||d===null)throw new Error("bogus")}catch(e){d={}}_.each(b,function(b){d[b]=a}),c.emailToUserID=JSON.stringify(d)}function K(a){try{var b=JSON.parse(c.usersComputer);if(typeof b!="object")throw new Error("bogus");var d=b[a];d&&(b[a]=null,delete b[a],c.usersComputer=JSON.stringify(b))}catch(e){}}function J(a){try{a=B(a);var b=JSON.parse(c.usersComputer);if(typeof b!="object")throw new Error("bogus");var d=b[a]||{};d.state="ask",c.usersComputer=JSON.stringify(b)}catch(e){}}function I(a){D(a,"denied")}function H(a){D(a,"confirmed")}function G(a){D(a,"seen")}function F(b){if(typeof b!="number")return!1;try{b=B(b);var d=JSON.parse(c.usersComputer),e=d[b];if(e){var f=e.state,g=new Date-Date.parse(e.updated);if(f==="ask")return!0;if(f==="confirmed")return!1;if(f==="denied"&&g>a)return!0;if(f==="seen"&&g>6e4)return!0}}catch(h){return!0}return!1}function E(a){try{a=B(a);var b=JSON.parse(c.usersComputer||"{}");return b[a].state==="confirmed"}catch(d){return!1}}function D(b,d){b=B(b);if(typeof b!="number")throw new Error("bad userid "+b);if(!C(d))throw new Error("invalid state");var e,f,g=0;try{e=JSON.parse(c.usersComputer);if(typeof e!="object")throw new Error("bogus");var h=e[b];if(h){f=h.state,g=Date.parse(h.updated);if(!C(f))throw new Error("corrupt/outdated");if(isNaN(g))throw new Error("corrupt/outdated")}}catch(i){f=undefined,g=0,e={}}f==="denied"&&(new Date).getTime()-g>a&&(f=undefined,g=0);if(d!=="seen"||!f)e[b]={state:d,updated:(new Date).toString()},c.usersComputer=JSON.stringify(e)}function C(a){return a==="seen"||a==="confirmed"||a==="denied"}function B(a){if(typeof a=="number")return a;var b=JSON.parse(c.emailToUserID||"{}");return b[a]}function A(){var a=JSON.parse(c.siteInfo||"{}");for(var b in a)delete a[b].logged_in;c.siteInfo=JSON.stringify(a)}function z(a,b){function d(){var d=s(a,"logged_in");c!==d&&(b(),c=d)}var c=s(a,"logged_in");window.addEventListener?window.addEventListener("storage",d,!1):window.setInterval(d,2e3)}function y(){var a=0,b=JSON.parse(c.siteInfo||"{}");for(var d in b)b[d].logged_in&&a++;return a}function x(a,b){var d=JSON.parse(c[a]||"{}");delete d[b],c[a]=JSON.stringify(d)}function w(a,b){var d=JSON.parse(c[a]||"{}");return d[b]}function v(a,b,d){var e=JSON.parse(c[a]||"{}");e[b]=d,c[a]=JSON.stringify(e)}function u(a){var b=JSON.parse(c.siteInfo||"{}");return _.size(b)}function t(a,b){var d=JSON.parse(c.siteInfo||"{}"),e=d[a];e&&(delete e[b],_.size(e)||delete d[a],c.siteInfo=JSON.stringify(d))}function s(a,b){var d=JSON.parse(c.siteInfo||"{}"),e=d[a];return e&&e[b]}function r(a,b,d){var e=JSON.parse(c.siteInfo||"{}"),f=e[a]=e[a]||{};if(b==="email"&&!l(d))throw new Error("unknown email address");f[b]=d,c.siteInfo=JSON.stringify(e)}function q(){var a;try{var b=JSON.parse(c.returnTo);if(b){if(new Date-new Date(b.at)>3e5)throw new Error("stale");if(typeof b.url!="string")throw new Error("malformed");a=b.url}}catch(d){c.removeItem("returnTo")}return a}function p(a){c.returnTo=JSON.stringify({at:(new Date).toString(),url:a})}function o(a,b){var c=l(a,b);if(c)delete c.priv,delete c.pub,delete c.cert,m(a,c,b);else throw new Error("unknown email address")}function n(a,b){var d=j(b);if(!d[a])throw new Error("unknown email address");delete d[a],g(d,b);var e=JSON.parse(c.siteInfo||"{}");for(var f in e)e[f].email===a&&delete e[f].email,e[f].logged_in===a&&delete e[f].logged_in;c.siteInfo=JSON.stringify(e)}function m(a,b,c){var d=j(c);b=b||{},d[a]=b,g(d,c)}function l(a,b){var c=j(b);return c&&c[a]}function k(a){return _.size(j(a))}function j(a){try{var b=JSON.parse(c.emails||"{}");if(b)return b[f(a)]||{}}catch(d){}h();return{}}function i(){_.each({emailToUserID:{},emails:{},interaction_data:{},main_site:{},managePage:{},returnTo:null,siteInfo:{},stagedOnBehalfOf:null,usersComputer:{}},function(a,b){c[b]||(c[b]=JSON.stringify(a))})}function h(){c.removeItem("emails"),c.removeItem("siteInfo"),c.removeItem("managePage"),i()}function g(a,b){var d;try{d=JSON.parse(c.emails||"{}")}catch(e){h(),d={}}d[f(b)]=a,c.emails=JSON.stringify(d)}function f(a){return a||"default"}function e(){var a=JSON.parse(c.loggedIn||"{}");for(var b in a)r(b,"logged_in",a[b]);c.removeItem("loggedIn")}"use strict";var a=864e5,b=36e5,c=BrowserID.getStorage(),d=window;i(),e();return{addEmail:m,getEmails:j,getEmailCount:k,getEmail:l,removeEmail:n,invalidateEmail:o,site:{set:r,get:s,remove:t,count:u},manage_page:{set:v.curry("managePage"),get:w.curry("managePage"),remove:x.curry("managePage")},usersComputer:{confirmed:E,setConfirmed:H,setDenied:I,shouldAsk:F,setSeen:G,clear:K,forceAsk:J},updateEmailToUserIDMapping:L,loggedInCount:y,watchLoggedIn:z,logoutEverywhere:A,clear:h,setReturnTo:p,getReturnTo:q,setDefaultValues:i,idpVerification:{get:N,set:O,clear:P,INFO_LIFESPAN_MS:b},upgradeLoggedInInfo:e}}(),BrowserID.XHRTransport=window.Micrajax,BrowserID.XHR=function(){function p(a){o(function(){var b=a.data||{};b.csrf=b.csrf||f;var c=_.extend(a,{type:"POST",data:JSON.stringify(b),contentType:"application/json",processData:!1,defer_success:!0});m(c)},a.error)}function o(a,c){typeof e!="undefined"?a(e):m({type:"GET",url:"/wsapi/session_context",success:function(c){f=c.csrf_token,e=c,b.publish("context_info",c),a&&a(c)},error:c})}function n(a){var b=_.extend(a,{type:"GET",defer_success:!0});m(b)}function m(a){var e=a.success,f=a.error,h,i={network:{type:a.type.toUpperCase(),url:a.url},eventTime:new Date},m=function(b,c,d){h&&(clearTimeout(h),h=null),l(i),a.defer_success?_.defer(e.curry(b,c,d)):e(b,c,d)},n=function(a,b,c){h&&(clearTimeout(h),h=null),l(i),_.defer(j.curry(f,i,a,b,c))},o=_.extend({},a,{success:m,error:n,headers:{"BrowserID-git-sha":d}});g&&(h=setTimeout(k.curry(i),g)),b.publish("xhr_start",i),c.ajax(o)}function l(a){a.duration=new Date-a.eventTime,b.publish("xhr_complete",a)}function k(a){b.publish("xhr_delay",a)}function j(a,c,d,e,f){c=c||{},c.network=_.extend(c.network||{},{status:d&&d.status,textStatus:e,errorThrown:f,responseText:d.responseText}),b.publish("xhr_error",c),a&&a(c)}function i(a){a.hasOwnProperty("transport")&&(c=a.transport),a.hasOwnProperty("time_until_delay")&&(g=a.time_until_delay),h()}function h(){f=e=undefined}"use strict";var a=BrowserID,b=a.Mediator,c=a.XHRTransport,d=BrowserID.CODE_VERSION,e,f,g;return{init:i,get:n,post:p,withContext:o,clearContext:h}}(),BrowserID.Network=function(){function p(a,b,c,d,e){var f={token:b};c!==null&&(f.pass=c),i({url:a,data:f,success:d,error:e})}function o(a,c,d,e){i({url:c,data:a,success:function(a){a.success?b(d,a):b(d,!1)},error:function(a){a.network.status===429?b(d,!1):b(e,a)}})}function n(){h.clearContext();var a;c=d=a}function m(a,d){if(typeof c!="undefined")b(a,c);else{try{document.cookie="can_set_cookies=1"}catch(e){}h.withContext(a,d)}}function l(a,b){c=b,d={remote:b.server_time,local:(new Date).getTime()},e=b.domain_key_creation_time,f=b.code_version}"use strict";var a=BrowserID,b=a.Helpers.complete,c,d,e,f,g=a.Mediator,h=a.XHR,i=h.post,j=h.get,k=a.Storage,q={init:function(a){g.subscribe("context_info",l),this.cookiesEnabledOverride=a&&a.cookiesEnabledOverride,n()},authenticate:function(a,b,c,d,e){i({url:"/wsapi/authenticate_user",data:{email:a,pass:b,ephemeral:!k.usersComputer.confirmed(a),allowUnverified:c},success:d,error:e})},authenticateWithAssertion:function(a,b,c,d){i({url:"/wsapi/auth_with_assertion",data:{assertion:b,ephemeral:!k.usersComputer.confirmed(a)},success:c,error:d})},withContext:m,setContext:function(a,b){c&&(c[a]=b)},clearContext:n,logout:function(a,c){i({url:"/wsapi/logout",success:a,error:function(d,e,f){d.network.status===400?b(a):b(c,d)}})},createUser:function(a,b,c,d,e,f){var g={email:a,pass:b,site:c,allowUnverified:d};o(g,"/wsapi/stage_user",e,f)},emailForVerificationToken:function(a,c,d){j({url:"/wsapi/email_for_token?token="+encodeURIComponent(a),success:function(a){var d=null;a.success!==!1&&(d=_.extend({needs_password:!1},a)),b(c,d)},error:d})},checkUserRegistration:function(a,b,c){j({url:"/wsapi/user_creation_status?email="+encodeURIComponent(a),success:b,error:c})},completeUserRegistration:p.curry("/wsapi/complete_user_creation"),completeEmailRegistration:p.curry("/wsapi/complete_email_confirmation"),requestPasswordReset:function(a,b,c,d){var e={email:a,site:b};o(e,"/wsapi/stage_reset",c,d)},completePasswordReset:p.curry("/wsapi/complete_reset"),checkPasswordReset:function(a,b,c){j({url:"/wsapi/password_reset_status?email="+encodeURIComponent(a),success:b,error:c})},requestEmailReverify:function(a,b,c,d){var e={email:a,site:b};o(e,"/wsapi/stage_reverify",c,d)},checkEmailReverify:function(a,b,c){j({url:"/wsapi/email_reverify_status?email="+encodeURIComponent(a),success:b,error:c})},sendInteractionData:function(a,c,d){i({url:"/wsapi/interaction_data",data:{data:a},success:function(a){b(c,a.success)},error:d})},changePassword:function(a,b,c,d){i({url:"/wsapi/update_password",data:{oldpass:a,newpass:b},success:c,error:d})},cancelUser:function(a,b){i({url:"/wsapi/account_cancel",success:a,error:b})},addEmailWithAssertion:function(a,c,d){i({url:"/wsapi/add_email_with_assertion",data:{assertion:a},success:function(a){b(c,a.success)},error:d})},addSecondaryEmail:function(a,b,c,d,e){var f={email:a,pass:b,site:c};o(f,"/wsapi/stage_email",d,e)},checkEmailRegistration:function(a,b,c){j({url:"/wsapi/email_addition_status?email="+encodeURIComponent(a),success:b,error:c})},emailRegistered:function(a,c,d){j({url:"/wsapi/have_email?email="+encodeURIComponent(a),success:function(a,d,e){b(c,a.email_known)},error:d})},addressInfo:function(a,c,d,e){c=c||"default",j({url:"/wsapi/address_info?email="+encodeURIComponent(a)+"&issuer="+encodeURIComponent(c),success:function(a,c,e){b(d,a)},error:e})},removeEmail:function(a,c,d){i({url:"/wsapi/remove_email",data:{email:a},success:function(a,d,e){b(c,a.success)},error:d})},certKey:function(a,b,c,d,e,f){var g={email:a,pubkey:b.serialize(),ephemeral:!k.usersComputer.confirmed(a),allowUnverified:d};c!=="default"&&(g.forceIssuer=c),i({url:"/wsapi/cert_key",data:g,success:e,error:f})},listEmails:function(a,c){j({url:"/wsapi/list_emails",success:function(c){b(a,c.emails)},error:c})},serverTime:function(a,c){m(function(){try{if(!d)throw new Error("can't get server time!");var e=(new Date).getTime()-d.local;b(a,new Date(e+d.remote))}catch(f){b(c,f.toString())}},c)},domainKeyCreationTime:function(a,c){m(function(){try{if(!e)throw new Error("can't get domain key creation time!");b(a,new Date(e))}catch(d){b(c,d.toString())}},c)},codeVersion:function(a,c){m(function(){b(a,f)},c)},cookiesEnabled:function(a,c){m(function(c){var d=c.cookies;typeof q.cookiesEnabledOverride=="boolean"&&(d=q.cookiesEnabledOverride),b(a,d)},c)},prolongSession:function(a,b){i({url:"/wsapi/prolong_session",success:a,error:b})},usedAddressAsPrimary:function(a,b,c){i({url:"/wsapi/used_address_as_primary",data:{email:a},success:b,error:c})},requestTransitionToSecondary:function(a,b,c,d,e){var f={email:a,pass:b,site:c};o(f,"/wsapi/stage_transition",d,e)},completeTransitionToSecondary:p.curry("/wsapi/complete_transition"),checkTransitionToSecondary:function(a,b,c){j({url:"/wsapi/transition_status?email="+encodeURIComponent(a),success:b,error:c})}};return q}(),BrowserID.CryptoLoader=function(){function j(a,b){g?b(g):h?i.push(b):(e("https://login.persona.org/v/4049fb4a77/production/bidbundle.js"),i.push(b),h=!0,f("require",window,function(){g=window.require("./lib/jwcrypto"),g.addEntropy(a),h=!1,_.each(i,function(a){a(g)})}))}function f(a,b,c){if(a in b)return c();setTimeout(function(){f(a,b,c)},d)}function e(a){var b=document.createElement("script");b.setAttribute("src",a);var c=document.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}"use strict";var a=BrowserID,b=a.Mediator,c=a.Network,d=50,g,h,i=[],k={load:function(a,b){c.withContext(function(b){j(b.random_seed,a)},b)}};return k}(),BrowserID.Provisioning=function(){"use strict";var a=BrowserID.CryptoLoader,b=2e4,c=function(c,d,e){function l(){f&&clearTimeout(f),f=setTimeout(function(){h("timeoutError","Provisioning timed out.")},b)}function h(a,b){g();return setTimeout(function(){e({code:a,msg:b})},0)}function g(){f&&(f=clearTimeout(f)),m&&m.destroy(),m=undefined,k&&document.body.removeChild(k),k=undefined}var f;if(!e)throw new Error("missing required failure callback");if(!c||!c.email||!c.url||!c.hasOwnProperty("ephemeral"))return h("internal","missing required arguments");var i;try{i=/^(https?:\/\/[^\/]+)\//.exec(c.url)[1]}catch(j){}if(!i)return h("internal","bad provisioning url, can't extract origin");var k=document.createElement("iframe");k.setAttribute("src",c.url),k.style.display="none",k.addEventListener?k.addEventListener("load",l,!1):k.attachEvent&&k.attachEvent("onload",l),document.body.appendChild(k);var m=Channel.build({window:k.contentWindow,origin:i,scope:"vep_prov"}),n;m.bind("beginProvisioning",function(a,b){return{email:c.email,cert_duration_s:c.ephemeral===!1?21600:3600}}),m.bind("genKeyPair",function(b,c){b.delayReturn(!0),a.load(function(a){a.generateKeypair({algorithm:"DS",keysize:BrowserID.KEY_LENGTH},function(a,c){n=c,b.complete(n.publicKey.serialize())})})}),m.bind("raiseProvisioningFailure",function(a,b){g(),h("primaryError",b)}),m.bind("registerCertificate",function(a,b){g(),d(n,b)})};return c}(),BrowserID.User=function(){function L(a,b,c,e,f){var g=f.success;if(typeof g!="boolean")return e("unexpected server response: "+g);K(g&&b,f.userid),g?(f.suppress_ask_if_users_computer&&d.usersComputer.setConfirmed(s),h.syncEmails(function(){m(c,g)},e)):m(c,g)}function K(a,b){if(window.$){var e=!a?"removeClass":"addClass";$("body")[e]("authenticated")}t=a,s=a&&b,c.setContext("auth_level",a),c.setContext("userid",b),!!t&&s?d.usersComputer.setSeen(s):d.clear()}function J(){var a;s=t=a,c.clearContext()}function I(a,b){c.withContext(a,b)}function H(a,b){K(b.auth_level,b.userid)}function G(a,b,d,e){c.certKey(a,b.publicKey,u,v,function(c){E(a,b,c,d,e)},e)}function F(a,b){d.addEmail(a.email,{created:new Date},b)}function E(a,b,c,e,f){h.addressInfo(a,function(f){var g=new Date,h=d.getEmail(a,u)||{created:g};_.extend(h,{updated:g,pub:b.publicKey.toSimpleObject(),priv:b.secretKey.toSimpleObject(),cert:c}),f.state==="unverified"?h.unverified=!0:h.unverified&&delete h.unverified,d.addEmail(a,h,u),e&&e(!0)},f)}function D(a){return e.getDomainFromEmail(a.email)}function C(){i&&(clearTimeout(i),i=null)}function B(a,b,c,e){function j(){a(b,function(a){var b=a.status;b==="complete"||b==="mustAuth"?f(a):b==="pending"?i=setTimeout(j,p):m(e,b)},e)}function g(a){d.setReturnTo(""),n=!0,a.status==="complete"&&K("password",a.userid),s&&t?h.syncEmails(function(){m(c,a.status)},e):m(c,a.status)}function f(a){q&&r?(h.authenticate(q,r,function(b){a.userid=s,a.status=b?"complete":"mustAuth",g(a)},e),q=r=null):(J(),h.checkAuthentication(function(b){a.status==="complete"&&b!=="password"&&(a.status="mustAuth"),a.userid=s,g(a)},e))}j()}function A(a,b,c,e,f){h.tokenInfo(b,function(g){var h={valid:!1};g?a(b,c,function(a){var b=a.success,c=h;b&&(c=_.extend({valid:b},g),d.setReturnTo(""),t="password"),m(e,c)},f):e&&e(h)},f)}function z(a,b,c,e,f){q=a,r=b,c(function(a){a||(a={success:!1});var b=a.success;b||(a.reason="throttle");var c=h.getReturnTo();b&&c&&d.setReturnTo(c),m(e,a)},f)}function y(a,b){c.serverTime(function(f){c.domainKeyCreationTime(function(b){function c(a){var c=a.payload.exp.valueOf()-f.valueOf();if(c<12e4)return!0;if(!a.payload.iat){e.log("Data Format ERROR: expected cert to have iat property, but found none, marking expired");return!0}if(a.payload.iat<b){e.log("Certificate issued "+a.payload.iat+" is before creation time "+b+", marking expired");return!0}return!1}var h=d.getEmails(u),i={};g.load(function(b){_.each(h,function(a,f){try{a.pub=b.loadPublicKeyFromObject(a.pub)}catch(g){d.invalidateEmail(f,u);return}if(!a.cert)d.invalidateEmail(f,u);else try{var i=b.extractComponents(h[f].cert);c(i)&&d.invalidateEmail(f,u)}catch(j){e.log("error parsing cert for"+f+":"+j),d.invalidateEmail(f,u)}}),a()})},b)},b)}function x(a){return _.indexOf(w,a)>-1}"use strict";var a,b=BrowserID,c=b.Network,d=b.Storage,e=b.Helpers,f=b.Mediator,g=b.CryptoLoader,h,i,j=b.Provisioning,k={},l={},m=b.Helpers.complete,n=!1,o=3e3,p=o,q,r,s,t,u="default",v=!1,w=["transition_to_secondary","transition_no_password","transition_to_primary"];h={init:function(a){a=a||{},f.subscribe("context_info",H),a.provisioning&&(j=a.provisioning),a.pollDuration&&(p=a.pollDuration),a.issuer&&(u=a.issuer)},reset:function(){j=BrowserID.Provisioning,h.resetCaches(),n=!1,p=o,q=r=s=t=null,u="default",v=!1},resetCaches:function(){k={},l={}},setNetwork:function(a){c=a},setOrigin:function(b){a=b},getOrigin:function(){return a},setOriginEmail:function(b){d.site.set(a,"email",b)},getOriginEmail:function(){return d.site.get(a,"email")},getHostname:function(){return a.replace(/^.*:\/\//,"").replace(/:\d*$/,"")},setReturnTo:function(a){this.returnTo=a},getReturnTo:function(){return this.returnTo},setIssuer:function(a){u=a},getIssuer:function(){return u},isDefaultIssuer:function(){return u==="default"},setAllowUnverified:function(a){v=a},userid:function(){return s},withContext:I,clearContext:J,createSecondaryUser:function(b,d,e,f){z(b,d,c.createUser.bind(c,b,d,a,v),function(a){if(a.unverified){var c=k[b];c&&(c.state="unverified")}m(e,a)},f)},createPrimaryUser:function(a,b,c){var d=a.email;h.provisionPrimaryUser(d,a,function(a,e){a==="primary.verified"?h.authenticateWithAssertion(d,e.assertion,function(a){a?b("primary.verified"):b("primary.could_not_add")},c):b(a,e)},c)},provisionPrimaryUser:function(a,b,c,d){h.primaryUserAuthenticationInfo(a,b,function(e){e.authenticated?E(a,e.keypair,e.cert,function(){h.getAssertion(a,"https://login.persona.org",function(a){a?c("primary.verified",{assertion:a}):c("primary.could_not_add")},d)}):c("primary.verify",b)},d)},primaryUserAuthenticationInfo:function(a,b,c,e){function h(b){l[a]=b,c&&_.defer(function(){c(b)})}var f=d.getEmail(a,u),g=this;l=l||{};if(l[a])return h(l[a]);if(f&&f.cert){var i=_.extend({authenticated:!0},f,b);return h(i)}j({email:a,url:b.prov,ephemeral:!d.usersComputer.confirmed(a)},function(a,c){var d=_.extend({keypair:a,cert:c,authenticated:!0},b);h(d)},function(a){if(a.code==="primaryError"){var c=_.extend({authenticated:!1},b);h(c)}else e($.extend(b,{action:{message:a}}))})},isUserAuthenticatedToPrimary:function(a,b,c,d){h.primaryUserAuthenticationInfo(a,b,function(
a){c(a.authenticated)},d)},waitForUserValidation:B.curry(c.checkUserRegistration),cancelUserValidation:C,tokenInfo:function(a,b,e){c.emailForVerificationToken(a,function(a){a&&(a=_.extend(a,{returnTo:d.getReturnTo()})),m(b,a)},e)},verifyUser:A.curry(c.completeUserRegistration),canSetPassword:function(a,b){I(function(b){m(a,b.has_password)},b)},changePassword:function(a,b,d,e){c.changePassword(a,b,function(a){a.success&&K("password",s),m(d,a.success)},e)},requestPasswordReset:function(b,d,e){h.addressInfo(b,function(f){f.state==="unknown"?m(d,{success:!1,reason:"invalid_email"}):f.type==="primary"?m(d,{success:!1,reason:"primary_address"}):z(b,null,c.requestPasswordReset.bind(c,b,a),d,e)},e)},completePasswordReset:A.curry(c.completePasswordReset),waitForPasswordResetComplete:B.curry(c.checkPasswordReset),cancelWaitForPasswordResetComplete:C,requestEmailReverify:function(b,e,f){d.getEmail(b,u)?z(b,null,c.requestEmailReverify.bind(c,b,a),e,f):m(e,{success:!1,reason:"invalid_email"})},waitForEmailReverifyComplete:B.curry(c.checkEmailReverify),cancelWaitForEmailReverifyComplete:C,requestTransitionToSecondary:function(b,d,e,f){h.addressInfo(b,function(g){g.state==="unknown"?m(e,{success:!1,reason:"invalid_email"}):g.type==="primary"?m(e,{success:!1,reason:"primary_address"}):z(b,d,c.requestTransitionToSecondary.bind(c,b,d,a),e,f)},f)},completeTransitionToSecondary:A.curry(c.completeTransitionToSecondary),waitForTransitionToSecondaryComplete:B.curry(c.checkTransitionToSecondary),cancelWaitForTransitionToSecondaryComplete:C,cancelUser:function(a,b){c.cancelUser(function(){K(!1),a&&a()},b)},logoutUser:function(a,b){h.checkAuthentication(function(e){e?(d.logoutEverywhere(),c.logout(function(){K(!1),m(a,!!e)},b)):m(a,e)},b)},syncEmails:function(a,b){y(function(){var e=h.getStoredEmailKeypairs();c.listEmails(function(b){s&&d.updateEmailToUserIDMapping(s,b);var c=_.keys(e),f=[_.difference(b,c)],g=[_.difference(c,b)],i=[_.intersection(c,b)];if(!h.isDefaultIssuer()){var j=d.getEmails(u),k=_.keys(j);f.push(_.difference(b,k)),g.push(_.difference(k,b)),i.push(_.intersection(k,b))}_.each(g,function(a,b){_.each(a,function(a){0===b?d.removeEmail(a,"default"):d.removeEmail(a,u)})}),_.each(f,function(a,b){_.each(a,function(a){0===b?F({email:a},"default"):F({email:a},u)})}),m(a)},b)},b)},checkAuthentication:function(a,b){c.cookiesEnabled(function(c){c?I(function(){m(a,t||!1)},b):m(a,c)},b)},checkAuthenticationAndSync:function(a,b){h.checkAuthentication(function(c){c?h.syncEmails(function(){m(a,c)},b):m(a,c)},b)},authenticate:function(a,b,d,e){c.authenticate(a,b,v,L.curry(a,"password",d,e),e)},authenticateWithAssertion:function(a,b,d,e){c.authenticateWithAssertion(a,b,L.curry(a,"assertion",d,e),e)},isEmailRegistered:function(a,b,d){c.emailRegistered(a,b,d)},addressInfo:function(a,b,d){function e(c){k[a]=c,k[c.email]=c,b&&b(c)}if(k[a])return e(k[a]);c.addressInfo(a,u,function(b){var c=b.normalizedEmail||a;b.email=c,h.checkForInvalidCerts(c,b,function(a){a.type==="primary"?I(function(){h.isUserAuthenticatedToPrimary(c,a,function(b){a.authed=b,a.idpName=_.escape(D(a)),e(a)},d)},d):e(a)})},d)},checkForInvalidCerts:function(a,b,c){function f(a,b){delete b.priv,delete b.cert,delete l[a],d.addEmail(a,b)}g.load(function(d){var g=h.getStoredEmailKeypair(a);if(!g||!g.cert)return m(c,b);var i;try{i=d.extractComponents(g.cert).payload.iss}catch(j){e.log("Looking for issuer, error parsing cert for"+a+":"+String(j)),f(a,g)}b.issuer!==i?(f(a,g),b.issuerChange=!!i):g.unverified&&"unverified"!==b.state?f(a,g):x(b.state)&&f(a,g),m(c,b)})},addEmail:function(b,d,e,f){z(b,d,c.addSecondaryEmail.bind(c,b,d,a),e,f)},passwordNeededToAddSecondaryEmail:function(a,b){I(function(b){m(a,!b.has_password)},b)},waitForEmailValidation:B.curry(c.checkEmailRegistration),cancelEmailValidation:C,verifyEmail:A.curry(c.completeEmailRegistration),removeEmail:function(a,b,e){d.getEmail(a,u)?c.removeEmail(a,function(){d.removeEmail(a,u),m(b)},e):b&&b()},syncEmailKeypair:function(a,c,d){I(function(){g.load(function(e){e.generateKeypair({algorithm:"DS",keysize:b.KEY_LENGTH},function(b,e){G(a,e,c,d)})})})},getAssertion:function(a,b,e,f){function l(h){c.serverTime(function(c){g.load(function(f){var g=f.loadSecretKeyFromObject(h.priv),i=c.getTime()+12e4,k=new Date(i);setTimeout(function(){f.assertion.sign({},{audience:b,expiresAt:k},g,function(c,g){j=f.cert.bundle([h.cert],g),d.site.set(b,"email",a),d.site.set(b,"issuer",u),m(e,j)})},0)})},f)}var i=d.getEmail(a,u),j,k=this;i?i.priv?setTimeout(function(){l(i)},0):i.type==="primary"&&h.isDefaultIssuer()?h.addressInfo(a,function(c){h.provisionPrimaryUser(a,c,function(c){c==="primary.verified"?h.getAssertion(a,b,e,f):m(e,null)},f)},f):h.syncEmailKeypair(a,function(c){h.getAssertion(a,b,e,f)},f):m(e,null)},getStoredEmailKeypairs:function(){return d.getEmails(u)},getSortedEmailKeypairs:function(){var a=h.getStoredEmailKeypairs(),b=[];for(var c in a)a.hasOwnProperty(c)&&b.push({address:c,info:a[c]});b.sort(function(a,b){var c=a.address>b.address?1:a.address<b.address?-1:0;return c});return b},getStoredEmailKeypair:function(a){return d.getEmail(a,u)},clearStoredEmailKeypairs:function(){d.clear()},getSilentAssertion:function(b,c,e){h.checkAuthenticationAndSync(function(f){var g=d.site.get(a,"logged_in");if(!f||!g)return m(c,null,null);h.resetCaches(),h.addressInfo(g,function(d){if(x(d.state))return m(c,null,null);if(!d.issuerChange&&g===b)return m(c,g,null);h.getAssertion(g,a,function(a){m(c,a?g:null,a)},e)})},e)},logout:function(b,c){h.checkAuthentication(function(c){c&&d.site.remove(a,"logged_in"),b&&b(!!c)},c)},setComputerOwnershipStatus:function(a,b,e){I(function(){typeof s!="undefined"?a?(d.usersComputer.setConfirmed(s),c.prolongSession(b,e)):(d.usersComputer.setDenied(s),m(b)):m(e,"user is not authenticated")},e)},isUsersComputer:function(a,b){I(function(){typeof s!="undefined"?m(a,d.usersComputer.confirmed(s)):m(b,"user is not authenticated")},b)},shouldAskIfUsersComputer:function(a,b){I(function(){if(typeof s!="undefined"){var c=d.usersComputer.shouldAsk(s)&&!n;m(a,c)}else m(b,"user is not authenticated")},b)},usedAddressAsPrimary:function(a,b,d){h.checkAuthentication(function(e){e?c.usedAddressAsPrimary(a,b,d):m(d,"user is not authenticated")},d)}};var M=window.location.protocol+"//"+window.location.hostname;window.location.port&&(M+=":"+window.location.port),h.setOrigin(M);return h}(),BrowserID.Models={},BrowserID.Models.InteractionData=function(){function u(a){var b=s();if(b&&b.length!==0){var f=[];_.each(b,function(a){f.push(e(a,h))}),c.sendInteractionData(f,function(){t(),d(a,f)},function(b){b&&b.network&&b.network.status===413&&t(),d(a,!1)})}else d(a,!1)}function t(){var a=i();delete a.staged,j(a)}function s(){var a=i();return a.staged||[]}function r(a,b){return q(a,b)!==-1}function q(a,b){if(a)for(var c,d=0;c=a[d];++d)if(c[0]===b)return d;return-1}function p(){var a=l();if(!a||!a.orphaned)return!1;var b=a&&a.event_stream,c={"user.user_staged":"user.user_confirmed","user.email_staged":"user.email_confirmed","user.reset_password_staged":"user.reset_password_confirmed","user.reverify_email_staged":"user.reverify_email_confirmed"};for(var d in c){var e=c[d];if(r(b,d)&&!r(b,e))return!0}return!1}function o(a){p()&&localStorage.setItem(f,!0),n(),u(a)}function n(){var a=i();if(a.current){var b=a.staged=a.staged||[];b.unshift(a.current),delete a.current,j(a)}}function m(a){var b=i();b.current=a,j(b)}function l(){var a=i();return a.current}function k(a){n();var b=i();if(localStorage.getItem(f)){localStorage.removeItem(f);var c=a.event_stream||[];r(c,g)||(c.unshift([g,0]),a.event_stream=c)}b.current=a,j(b)}function j(a){try{b.interaction_data=JSON.stringify(a)}catch(c){b.removeItem("interaction_data")}}function i(){var a;try{a=JSON.parse(b.interaction_data)}catch(c){}return a||{}}"use strict";var a=BrowserID,b=a.getStorage(),c=a.Network,d=a.Helpers.complete,e=a.Helpers.whitelistFilter,f="sent_orphan_with_stage",g="staging_continuation",h=["event_stream","lang","screen_size","sample_rate","timestamp","number_emails","number_sites_signed_in","number_sites_remembered","orphaned","new_account","email_type","rp_api"];return{push:k,getCurrent:l,setCurrent:m,stageCurrent:n,publishCurrent:o,getStaged:s,publishStaged:u,clearStaged:t,hasEvent:r}}(),function(){function o(a,b){function k(){e!==null&&(e=null,f.site.remove(c,"logged_in"),a({method:"logout"}))}function j(b){a({method:"login",assertion:b,_internalParams:{silent:!0}})}function i(b){a({method:"ready"})}function h(){d.clearContext(),d.getSilentAssertion(e,function(a,b){a?(b&&j(b),e=a):e!==null&&k(),i()},function(a){g("silent return: err",a),k(),i()},g)}var c=b.origin,e=b.loggedInUser;n(c),h()}function n(a){d.setOrigin(a);var b=f.site.get(d.getOrigin(),"issuer");b&&d.setIssuer(b)}function m(a,b,c){function e(a){a=k(a),c&&c(a||null)}n(a),d.checkAuthenticationAndSync(function(a){a?d.getAssertion(b,d.getOrigin(),function(a){e(a||null)},e.curry(null)):e(null)},e.curry(null))}function l(a,b,c){var d=arguments,e;try{e=h.getRunningModule("dialog")}catch(f){return setTimeout(function(){l.apply(null,d)},50)}e.get(a,b,c,c)}function k(a){a!==null&&typeof a=="object"&&a.assertion&&(a=a.assertion);return a}function j(a){if(typeof a=="string")try{a=JSON.parse(a)}catch(b){g("invalid options string: "+a);throw b}return a}"use strict";var a=navigator,b=BrowserID,c=b.internal=b.internal||{},d=b.User,e=b.Network,f=b.Storage,g=b.Helpers.log,h=b.module,i=b.Models.InteractionData;e.init(),e.clearContext(),c.setPersistent=function(a,b){function c(a){b&&b(a)}d.checkAuthentication(function(b){b&&f.site.set(a,"remember",!0),c(!!b||null)},c.curry(null))},c.get=function(a,c,d,e){function n(a){try{i.publishCurrent()}catch(b){}a=k(a),c&&c(a||null)}g=e||b.Helpers.log;try{d=j(d)}catch(h){return}d=_.extend({},d);var o=!!d.silent;if(o){var p=d.requiredEmail||f.site.get(a,"email");p?m(a,p,n):n()}else d.rp_api="internal",l(a,d,n)},c.logout=function(a,b){function c(a){b&&b(a)}n(a),d.logout(b,c.curry(null))},c.logoutEverywhere=function(a){function b(b){a&&a(status)}d.logoutUser(a,b.curry(null))},c.watch=function(a,c,d){g=d||b.Helpers.log;try{c=j(c)}catch(e){return a({error:String(e)})}o(a,c)}}(),function(){function l(){d.watchLoggedIn(g,k)}function k(a){j||b.cookiesEnabled(function(b){if(!b)return a&&a();c.getSilentAssertion(i,function(b,c){i===b?f.notify({method:"match"}):b?(c&&f.notify({method:"login",params:c}),i=b):i!==null&&(f.notify({method:"logout"}),i=null),a&&a()},function(b){f.notify({method:"logout"}),i=null,a&&a()})})}function h(a){if(!g){g=a,c.setOrigin(g);var b=d.site.get(a,"issuer");c.setIssuer(b||"default")}}var a=BrowserID,b=a.Network,c=a.User,d=a.Storage,e=a.Models.InteractionData;d.setDefaultValues(),b.init(),c.init();var f=Channel.build({window:window.parent,origin:"*",scope:"mozid_ni"}),g,i,j=!1;f.bind("loggedInUser",function(a,b){i=b}),f.bind("loaded",function(a,b){a.delayReturn(!0),h(a.origin),k(function(){l(),a.complete()})}),f.bind("logout",function(a,b){h(a.origin),i!==null&&(d.site.remove(g,"logged_in"),i=null,f.notify({method:"logout"}))}),f.bind("dialog_running",function(a,b){j=!0}),f.bind("dialog_complete",function(a,c){j=!1;try{var f=e.getCurrent();f&&(_.extend(f,{number_emails:d.getEmailCount()||0,number_sites_signed_in:d.loggedInCount()||0,number_sites_remembered:d.site.count()||0}),e.setCurrent(f),e.publishCurrent())}catch(g){}b.clearContext(),k()})}()