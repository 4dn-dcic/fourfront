<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Dependency tracking and invalidation &#8212; 4D Nucleome Portal 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="JavaScript API Reference" href="jsdoc/index.html" />
    <link rel="prev" title="Authentication and authorization" href="authentication.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="jsdoc/index.html" title="JavaScript API Reference"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="authentication.html" title="Authentication and authorization"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">4D Nucleome Portal 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="static_documentation_contents.html" accesskey="U">Tutorials and Other Documents</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="dependency-tracking-and-invalidation">
<h1>Dependency tracking and invalidation<a class="headerlink" href="#dependency-tracking-and-invalidation" title="Permalink to this headline">¶</a></h1>
<p>Keeping elasticsearch in sync.</p>
<p>The /_indexer wsgi app (es_index_listener.py) drives the incremental indexing process. When a new transaction is notified by postgres (or after 60 seconds) it calls the /index view (indexer.py) which works out what needs to be reindexed. The actual reindexing happens in parallel in multiprocessing subprocesses (mpindexer.py.)</p>
<p>When rendering a response, we record the set of embedded_uuids and linked_uuids used.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">embedded_uuids</span></code> are those objects embedded into the response or whose properties have been consulted in rendering of the response. Any change to one of these objects should cause an invalidation. (See <code class="docutils literal"><span class="pre">Item.__json__</span></code>.)</li>
<li><code class="docutils literal"><span class="pre">linked_uuids</span></code> are the objects linked to in the response. Only changes to their url need trigger an invalidation. (See <code class="docutils literal"><span class="pre">Item.__resource_url__</span></code>.)</li>
</ul>
<p>When modifying objects, event subscribers keep track of which objects where updated and their resource paths before and after the modification. This is used to record the set of <code class="docutils literal"><span class="pre">updated_uuids</span></code> and <code class="docutils literal"><span class="pre">renamed_uuids</span></code> in the transaction log. (See indexing.py.)</p>
<p>The indexer process listens for notifications of new transactions. With the union of updated_uuids and union of renamed_uuids across each transaction in the log since its last indexing run, it performs a search for all objects where embedded_uuids intersect with the updated_uuids or linked_uuids intersect with the renamed_uuids. The result is the set of invalidated objects which must be reindexed in addition to those that were modified (recorded in updated_uuids.)</p>
<p>Where an object&#8217;s url depends on other objects – <code class="docutils literal"><span class="pre">Page</span></code> whose url includes its ancestors in its path, or <code class="docutils literal"><span class="pre">Target</span></code> whose url includes a property from its referenced organism – we must ensure that linked_uuid dependencies to those other objects are recorded in addition the object itself when linked. (See <code class="docutils literal"><span class="pre">Page.__resource_url__</span></code> and <code class="docutils literal"><span class="pre">Target.__resource_url__</span></code>.)</p>
<div class="section" id="total-reindexing">
<h2>Total Reindexing<a class="headerlink" href="#total-reindexing" title="Permalink to this headline">¶</a></h2>
<p>Cases can arise where a total reindexing needs to be triggered.
&gt;curl -XDELETE &#8216;localhost:9200/encoded/meta/indexing’  will specifically force it.</p>
<p>localhost:9200/encoded/meta/indexing stores the document that keeps track of incremental indexing. The indexer script checks for that document when deciding between full index and indexing only the recently invalidated documents. It has the benefit of keeping the old-yet-to-be-indexed data online, especially if it’s a production instance.</p>
<p>Alternatively, &gt;curl -XDELETE &#8216;<a class="reference external" href="http://localhost:9200/encoded/">http://localhost:9200/encoded/</a>&#8216; will delete the entire index along with the mapping information for schema objects. Although it does trigger indexing, missing mapping information makes the documets unsearcheable. Mapping in elasticsearch describes how each field of each object should be tokenized/analyzed/indexed for searching.</p>
</div>
<div class="section" id="back-references">
<h2>Back references<a class="headerlink" href="#back-references" title="Permalink to this headline">¶</a></h2>
<p>In a parent-child relationship, it is the child object that references the parent object. A parent response often renders a list of child objects, and that list my be filtered to remove deleted or unpublished child objects.</p>
<p>We want to ensure that parent responses are invalidated when a child object&#8217;s state changes, so that it would now be included in its parent&#8217;s list of child objects when it was not before. A parent response must therefore include all <em>potentially</em> included child objects in its <code class="docutils literal"><span class="pre">embedded_uuids</span></code>, which is done by accessing the child status property through the <code class="docutils literal"><span class="pre">Item.__json__</span></code> method.</p>
<p>We must also invalidate a parent response when a new child is added (either a new object of changing the parent referenced.) This is done adding the parent uuid to the list of updated_uuids recorded on the transaction adding/modifying the child. (See indexing.py <code class="docutils literal"><span class="pre">invalidate_new_back_revs</span></code>.)</p>
</div>
<div class="section" id="isolation-level-considerations">
<h2>Isolation level considerations<a class="headerlink" href="#isolation-level-considerations" title="Permalink to this headline">¶</a></h2>
<p>Postgres defaults to its lowest isolation level, READ COMMITTED: <a class="reference external" href="http://www.postgresql.org/docs/9.3/static/transaction-iso.html">http://www.postgresql.org/docs/9.3/static/transaction-iso.html</a></p>
<p>For invalidation of back references of new child objects only READ COMMITTED isolation is necessary as invalidated back references are calculated from the updated objects properties.</p>
<p>However, writes must be at least REPEATABLE READ in order for overalapping PATCHes to apply safely.</p>
<p>During recovery indexing uses READ COMMITTED isolation. Indexed objects may be internally inconsistent if there are concurrent updates to embedded objects. But indexing is still eventually consistent as any concurrent update will invalidate the object and it will be reindexed later.</p>
<p>To avoid internal possible internal inconsistancies of indexed objects, SERIALIZABLE isolation is required. It is used once it becomes available when recovery is complete.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Dependency tracking and invalidation</a><ul>
<li><a class="reference internal" href="#total-reindexing">Total Reindexing</a></li>
<li><a class="reference internal" href="#back-references">Back references</a></li>
<li><a class="reference internal" href="#isolation-level-considerations">Isolation level considerations</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="authentication.html"
                        title="previous chapter">Authentication and authorization</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="jsdoc/index.html"
                        title="next chapter">JavaScript API Reference</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/invalidation.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="jsdoc/index.html" title="JavaScript API Reference"
             >next</a> |</li>
        <li class="right" >
          <a href="authentication.html" title="Authentication and authorization"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">4D Nucleome Portal 1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="static_documentation_contents.html" >Tutorials and Other Documents</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, 4DN-DCIC.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.3.
    </div>
  </body>
</html>